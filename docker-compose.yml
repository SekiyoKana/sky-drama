version: '3.8'

services:
  backend:
    build: 
      context: ./backend
    container_name: sky-drama-backend
    command: uvicorn app.main:app --host 0.0.0.0 --port 11451 --workers 2 --timeout-keep-alive 600
    ports:
      - "11451:11451"
    volumes:
      - ./backend/assets:/app/assets
      - ./backend/logs:/app/logs
      - ./backend/database.db:/app/database.db
    environment:
      - ASSETS_DIR=/app/assets
      - DATABASE_URL=sqlite:////app/database.db
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - SKYDRAMA_HTTP_PROXY=${SKYDRAMA_HTTP_PROXY:-}
      - SKYDRAMA_HTTPS_PROXY=${SKYDRAMA_HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,backend}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    networks:
      - app_network
    restart: always

  frontend:
    build: 
      context: ./frontend
    container_name: sky-drama-frontend
    ports:
      - "5173:80"
    depends_on:
      - backend
    # Nginx 容器通常不需要这些 env，除非你有专门的脚本处理 envsubst
    # 建议直接在 nginx.conf 里写死 backend:11451
    environment:
      - BACKEND_HOST=backend
      - BACKEND_PORT=11451
    networks:
      - app_network
    restart: always

networks:
  app_network:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450
